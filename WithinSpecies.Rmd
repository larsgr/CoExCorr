---
title: "Within species comparison"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Aim of the analysis

Compare sub-sets of samples from the same species to quantify the effect of the sample selection alone.

## Sample selection

For each species the samples are divided into two sub-sets by randomly selecting half of the studies. This ensures that the sub-sets do not contain any samples from the same study, such as replicate samples, but the number of samples in each sub-set will not be the same. The plot below gives an overview of the samples that were randomly selected for the subsets:

```{r}

# load subsets
ss <- 
  dir("data/subsets/withinSpecies",pattern = "sampleSubset.RDS",
      recursive = T,full.names = T) %>% 
  set_names(sub(".*/(..)/sampleSubset.RDS","\\1",.)) %>% 
  map( readRDS )

for( spc in names(ss)){
  m <- ss[[spc]]$subsetMat
  studySize <- table(ss[[spc]]$studyID)
  x1 <- cumsum(studySize)
  x0 <- c(0,x1[-length(x1)])
  plot(NULL,xlim=c(0,sum(studySize)),ylim=c(1,ncol(m)),
       xlab="sample index",ylab="replicate index", main=spc)
  for(i in 1:ncol(m)){
    segments(x0 = x0[m[ ,i]], x1 = x1[m[ ,i]], y0 = i, y1 = i)
  }
}

```


## Gene selection

To reduce the computational cost, only a subset of the genes shall be included. Genes with 1:1 orthologs are prioritized and if that is not enough then also use genes with 1:2 orthologs.

## Reference "ortholog" selection

Use the 1:1 orthologs as reference orthologs. Ranks are calculated once for each set of 1:1 orthologs against the other species.

## results

```{r}

withinRnks <- 
  data_frame( filename = dir("data/subsets/withinSpecies",
                      recursive = T,pattern="rnks",full.names = T)) %>% 
  mutate( spc = sub(".*/(..)/rnks_[0-9]+.RDS","\\1",filename),
          repNr = sub(".*/../rnks_([0-9]+).RDS","\\1",filename),
          rnks = map(filename, readRDS))




library(ggplot2)

# load Full CCS ranks
fullRnks <-
  data_frame( filename=dir("data/CCS",pattern="....11_rnks.RDS",full.names = T)) %>% 
  mutate(spc1 = sub(".*/(..)(..)11_rnks.RDS","\\1",filename),
         spc2 = sub(".*/(..)(..)11_rnks.RDS","\\2",filename),
         rnks = map(filename,readRDS),
         filename = NULL)

fullRnksT <-
  fullRnks %>% 
  mutate( rnks = map(rnks, ~ .x[[2]]) ) %>%  #only keep the Transposed ranks
  mutate( spc1_=spc1, spc1=spc2, spc2=spc1_, spc1_=NULL) # swap spc1 and spc2

fullRnks <- 
  fullRnks %>% 
  mutate( rnks = map(rnks, ~ .x[[1]]) ) %>%  #only keep the not Transposed ranks
  bind_rows(fullRnksT) # combine with Transposed ranks


withinRnksUnnested <- 
  withinRnks %>%
  mutate(spc1=spc, spc2=spc, typ="Within species",
         spc=NULL, filename=NULL) %>% 
  mutate(rnks = map(rnks,unlist)) %>% 
  unnest()
  
fullRnks %>% 
  unnest() %>% 
  mutate( typ="Between species" ) %>% 
  bind_rows( withinRnksUnnested ) %>% 
  mutate( logRnks = -log10(1.0001-rnks)) %>% 
  ggplot( aes( x=spc2, y=logRnks, fill=typ) ) +
  facet_wrap(~as.factor(spc1), nrow=1) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", size=2, shape=23)


withinRnksUnnested %>% 
  filter(spc1=="Gm") %>% 
  mutate( logRnks = -log10(1.0001-rnks)) %>% 
  ggplot( aes( x=repNr, y=logRnks) ) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", size=2, shape=23)





```

