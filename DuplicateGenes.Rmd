---
title: "Comparison of duplicated genes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dev = 'svg')
```

```{r loadPackages}
library(tidyverse)
library(ggplot2)
# source("R/calcRanks.R")
source("R/orthoUtils.R")
# source("R/divUtils.R")

```

## Aim of this analysis

investigate the expression similarity of duplicated genes

```{r loadRankOrthoTables}

orthoRankTables <-
  dir("data/ranks", pattern="...._orthoRanks.RDS",full.names=T)  %>%
  set_names(sub(".*/(....)_orthoRanks.RDS","\\1", .)) %>% 
  map(readRDS) %>% 
  map( function( orthoTable ){
    # anonymize the spc1 and spc2 columns in the table
    names(orthoTable)[1:2] <- c("SPC1", "SPC2")
    
    return(orthoTable)
  })

# calculate size of groups
grpSize <-
  lapply(orthoRankTables, function( orthoTable ){
    orthoTbl2Array(orthoTable) %>%
      as_data_frame() %>% 
      mutate( len1 = map_int(SPC1,length),
              len2 = map_int(SPC2,length))
  })


```

## Rank distribution and ortholog duplicity

The following plots show the distribution of ranks (i.e. -log10( Pval ) ) for each pair of species and for ortholog duplicity. "len1" refers to the number of ortholog copies in the first species and len2 in the second. (e.g. a 1:2 ortholog in At:Os would be AtOs len1=1 len2=2)


```{r plotOrthoRanks, fig.height=9,fig.width=15}
x <- 
  # add grpSize to orthoRankTables and concatenate into one table
  map2_df(grpSize, orthoRankTables, .id="spcPair",
        ~ .x %>% 
          unnest(SPC1) %>% 
          inner_join(.y, by = "SPC1")) %>% 
  # gather rnksT and rnks to one column
  gather( rnks, rnksT, key="rnkT", value="rnk") %>% 
  # remove NA's
  filter( !is.na(rnk), len1 < 6, len2 < 6) %>% 
  # log transform ranks
  mutate( logRnk = -log10(1.0001-rnk) ) 

x %>%  
  ggplot( aes( x=as.factor(len1), y=logRnk) ) +
  facet_grid(as.factor(len2) ~ as.factor(spcPair)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", size=2, shape=20)

```
The following heatmap of median ranks which may give a better overview:

```{r}
x %>% 
  group_by(spcPair,len1,len2) %>% 
  summarise( medRnk = median(logRnk)) %>% 
  ggplot() +
  geom_tile( aes(x=as.factor(len1),y=as.factor(len2),fill=medRnk) ) +
  facet_wrap( ~ as.factor(spcPair), nrow=2 ) +
  scale_fill_gradientn( colors = RColorBrewer::brewer.pal(5,"Spectral"),
                       values = scales::rescale(4:0),
                       limits = c(0,2)) +
  coord_equal() +
  theme_bw()
  

```
The main observation is that 1:1 orthologs clearly tend to have higher ranks than orthologs with any number of duplicates and that the ranks get lower when the number of orthologs increases. (Note that there is increased uncertainty in the median of the larger groups as they are more rare). An interresting pattern is that orthologs with either one or two copies in Gm seem to have the approximately same ranks. A possible explanation could be the recent duplication in Gm and that a high portion of the genes that prefer occurr in single copies haven't had time to lose its copy.




